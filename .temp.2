local inspect = require("inspect")
local player = require("player")
local obstacles = require("obstacles")

_HEIGHT = love.graphics.getHeight()
_WIDTH = love.graphics.getWidth()

local clouds_front = love.graphics.newImage("assets/clouds/clouds_front.png")
clouds_front:setFilter("linear", "nearest")
local clouds_back = love.graphics.newImage("assets/clouds/clouds_back.png")
clouds_front:setFilter("linear", "nearest")

local ps

local parallax_front_1
local parallax_front_2
local parallax_back_1
local parallax_back_2

local function draw_background(parallax)
  if parallax.x < -_WIDTH then
    parallax.x = _WIDTH - 1
  end
  love.graphics.draw(
    parallax.sprite,
    parallax.x,
    parallax.y,
    0,
    _WIDTH / parallax.width,
    parallax.background_height / parallax.height
  )

  if inspect.inspecting then
    love.graphics.setColor(parallax.inspectingColor)
    love.graphics.setLineWidth(12)
    love.graphics.rectangle("line", parallax.x, parallax.y, _WIDTH, parallax.background_height)
    love.graphics.setColor(1, 1, 1, 1)
  end
end

local wind_emit_timer = 0
local wind_emit_interval = 15

function love.load()
  parallax_front_1 = {
    sprite = clouds_front,
    width = clouds_front:getWidth(),
    height = clouds_front:getHeight(),
    background_height = _HEIGHT / 2.4,
    x = 0,
    y = _HEIGHT - _HEIGHT / 2.4,
    inspectingColor = { 1, 0, 0, 0.5 },
    speed = 1,
  }
  parallax_front_2 = {
    sprite = clouds_front,
    width = clouds_front:getWidth(),
    height = clouds_front:getHeight(),
    background_height = _HEIGHT / 2.4,
    x = _WIDTH,
    y = _HEIGHT - _HEIGHT / 2.4,
    inspectingColor = { 0, 1, 0, 0.5 },
    speed = 1,
  }

  parallax_back_1 = {
    sprite = clouds_back,
    width = clouds_back:getWidth(),
    height = clouds_back:getHeight(),
    background_height = _HEIGHT / 1.75,
    x = 0,
    y = _HEIGHT - _HEIGHT / 1.75,
    inspectingColor = { 1, 0, 0, 0.5 },
    speed = 0.5,
  }
  parallax_back_2 = {
    sprite = clouds_back,
    width = clouds_back:getWidth(),
    height = clouds_back:getHeight(),
    background_height = _HEIGHT / 1.75,
    x = _WIDTH,
    y = _HEIGHT - _HEIGHT / 1.75,
    inspectingColor = { 0, 1, 0, 0.5 },
    speed = 0.5,
  }

  player.load()
  obstacles.load()
  inspect.load()

  local image1 = love.graphics.newImage("star.png")
  image1:setFilter("linear", "linear")

  ps = love.graphics.newParticleSystem(image1, 1000)
  ps:setColors(
    115 / 255, -- start color
    95 / 255,
    50 / 255,
    1
  )
  ps:setDirection(math.pi)
  ps:setEmissionArea("borderrectangle", 0, _HEIGHT, 0, false)
  ps:setEmissionRate(1)
  ps:setInsertMode("top")
  ps:setLinearDamping(0.003, 0.004)
  ps:setParticleLifetime(300, 360)
  ps:setSizes(0.025, 0.2)
  ps:setSizeVariation(0.75)
  ps:setRelativeRotation(true)
  ps:setRotation(0, 0.1)
  ps:setSpeed(5, 10)

  local dt = 0.1
  for time = 0, 500, dt do
    ps:update(dt)
  end

  love.graphics.setBackgroundColor(2 / 255, 29 / 255, 53 / 255, 1)
end

function love.update(dt)
  parallax_front_1.x = parallax_front_1.x - parallax_front_1.speed
  parallax_front_2.x = parallax_front_2.x - parallax_front_2.speed
  parallax_back_1.x = parallax_back_1.x - parallax_back_1.speed
  parallax_back_2.x = parallax_back_2.x - parallax_back_2.speed
  player.update(dt)
  obstacles.update(dt)
  inspect.update(dt)
  ps:update(dt)

  wind_emit_timer = wind_emit_timer + dt
  if wind_emit_timer > wind_emit_interval then
    wind_emit_timer = 0
    ps:emit(0.1)
  end
end

function love.draw()
  inspect.draw(function()
    love.graphics.draw(ps, _WIDTH + 64, 0)
    draw_background(parallax_back_1)
    draw_background(parallax_back_2)
    draw_background(parallax_front_1)
    draw_background(parallax_front_2)

    player.draw()
    obstacles.draw()
  end)
end

function love.keypressed(key)
  inspect.keypressed(key)
end
